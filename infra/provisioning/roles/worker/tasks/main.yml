#SPDX-License-Identifier: MIT-0
---
# tasks file for worker
- name: Get cluster join token
  shell: kubeadm token list -o=jsonpath='{.token}'
  become: yes
  delegate_to: "{{ groups.masters[0] }}"
  run_once: true
  register: cluster_join_token

- name: Get cluster cert sha
  shell: openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | \
    openssl dgst -sha256 -hex | sed 's/^.* //'
  become: yes
  delegate_to: "{{ groups.masters[0] }}"
  run_once: true
  register: cluster_cert_sha


- name: Join cluster
  shell: "kubeadm join --token {{ cluster_join_token.stdout }} {{ hostvars[groups.masters[0]]['ansible_default_ipv4']['address'] }}:6443 --discovery-token-ca-cert-hash sha256:{{ cluster_cert_sha.stdout }}"
  become: yes
